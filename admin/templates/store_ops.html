{% extends "store_base.html" %}
{% block store_content %}
<h2>営業状況</h2>

<div class="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;">
  {% for s in seats %}
  <div class="card" data-id="{{ s.id }}">
    <h3>{{ s.label }}</h3>

    <p>状態：
      <span class="state-chip {{ 'is-open' if s.get('open') else 'is-empty' }}">
        <span class="state-text">{{ '接客中' if s.get('open') else '空席' }}</span>
      </span>
    </p>

    <div class="field">
      <label>姫の名前
        <input class="guest" value="{{ s.guest_name or '' }}">
      </label>
    </div>

    <div class="field">
      <label>担当ホスト
        <select class="host">
          <option value="0" {% if not s.get('host_id') %}selected{% endif %}>未選択</option>
          {% for h in hosts %}
            <option value="{{ h.id }}" {% if s.get('host_id')==h.id %}selected{% endif %}>{{ h.name }}</option>
          {% endfor %}
        </select>
      </label>
    </div>

    <div class="actions">
      <button class="btn mark-open">{{ s.get('open') and '空席にする' or '接客中にする' }}</button>
      <button class="btn danger checkout">会計</button>
    </div>

    <hr>

    <div>
      <label>注文追加
        <select class="liquor">
          {% for l in liquors %}
            <option value="{{ l.id }}" data-price="{{ l.sale_price|int }}" data-stock="{{ l.stock|int }}">
              {{ l.name }}（¥{{ '%.0f'|format(l.sale_price) }} / 在庫{{ l.stock }}）
            </option>
          {% endfor %}
        </select>
        <input class="qty" type="number" value="1" min="1" style="width:64px;">
        <!-- 確認は inline の onclick で表示。キャンセル時は伝播停止 -->
        <button type="button"
                class="btn add"
                data-seat-label="{{ s.label }}"
                onclick="return confirmAdd(event, this)">
          追加
        </button>
      </label>

      <ul class="items">
        {% for it in s.get('items', []) %}
          <li>{{ it.name }} x {{ it.qty }} = ¥{{ '%.0f'|format(it.qty*it.unit_price) }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endfor %}
</div>

<script>
// ===== サーバが埋め込むURL/トークン =====
const ORDERS_ADD_URL = "{{ url_for('admin.store_orders_add') }}";      // 商品追加（在庫減算+SSE）
const SEATS_UPSERT_URL = "{{ url_for('admin.store_seats_upsert') }}";  // 席保存
const CHECKOUT_URL = "{{ url_for('admin.store_ops_checkout') }}";      // 会計
const LIQUOR_STATUS_URL = "{{ url_for('admin.store_liquors_status') }}"; // 在庫ポーリング
const EVENTS_URL = "{{ url_for('admin.store_events') }}";              // SSE
const CSRF_TOKEN = "{{ csrf_token() }}";

// 在庫セレクトの表示文字を更新
function updateLiquorOptionTexts(mapById){
  document.querySelectorAll('select.liquor').forEach(sel=>{
    Array.from(sel.options).forEach(opt=>{
      const id = parseInt(opt.value,10);
      const info = mapById[id];
      if(!info) return;
      const name  = info.name ?? opt.text.split('（')[0];
      const price = parseInt(info.sale_price ?? opt.dataset.price ?? '0', 10);
      const stock = parseInt(info.stock ?? opt.dataset.stock ?? '0', 10);
      opt.dataset.price = String(price);
      opt.dataset.stock = String(stock);
      opt.text = `${name}（¥${price} / 在庫${stock}）`;
    });
  });
}

// 共通POST(JSON)
async function postJSON(url, payload){
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRF-Token': CSRF_TOKEN},
    body: JSON.stringify(payload||{})
  });
  let j={}; try{ j=await res.json(); }catch(_){}
  if(!res.ok || j.ok===false){
    const msg = (j && (j.error||j.message)) || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return j;
}

(function(){
  // 各カードごとにリスナ設定
  document.querySelectorAll('.card').forEach(card=>{
    const seatId    = parseInt(card.dataset.id,10);
    const guest     = card.querySelector('.guest');
    const hostSel   = card.querySelector('.host');
    const stateText = card.querySelector('.state-text');
    const stateChip = card.querySelector('.state-chip');
    const btnOpen   = card.querySelector('.mark-open');
    const itemsUL   = card.querySelector('.items');
    const liquorSel = card.querySelector('.liquor');
    const qtyInput  = card.querySelector('.qty');
    const btnAdd    = card.querySelector('.add');

    async function saveSeat(payload){
      payload.id = seatId;
      await postJSON(SEATS_UPSERT_URL, payload);
      return true;
    }

    // 空席⇄接客中
    btnOpen.addEventListener('click', async ()=>{
      const willOpen = (stateText.textContent.trim() === '空席'); // 空席→接客中
      const ok = await saveSeat({
        open: willOpen,
        guest_name: guest.value,
        host_id: parseInt(hostSel.value||0,10)
      });
      if(ok){
        stateText.textContent = willOpen ? '接客中' : '空席';
        stateChip.classList.toggle('is-open',  willOpen);
        stateChip.classList.toggle('is-empty', !willOpen);
        btnOpen.textContent  = willOpen ? '空席にする' : '接客中にする';
      }
    });

    // 担当/姫名変更
    guest.addEventListener('change', ()=> saveSeat({ guest_name: guest.value }));
    hostSel.addEventListener('change', ()=> saveSeat({ host_id: parseInt(hostSel.value||0,10) }));

    // 注文追加（確認は onclick=confirmAdd で済ませ、OK時のみこのハンドラが実行される）
    btnAdd.addEventListener('click', async ()=>{
      const liquorId = parseInt(liquorSel.value, 10);
      const qty = Math.max(1, parseInt(qtyInput.value || '1', 10));
      if(!liquorId){ alert('商品を選択してください'); return; }
      try{
        // 在庫減算＆明細追加（サーバ側がSSEで inventory_update / seat_update / order_added を配信）
        await postJSON(ORDERS_ADD_URL, { seat_id: seatId, liquor_id: liquorId, qty });

        // すぐに在庫表示を整えたい場合は、1回だけポーリングを即時実行
        try{ await refreshLiquorsOnce(); }catch(_){}
        // 明細表示はSSEの seat_update/order_added で反映されるので、ここでは触らない
      }catch(e){
        if(String(e.message).includes('no_stock')) alert('在庫が足りません');
        else alert('追加に失敗しました: ' + e.message);
      }
    });

    // 会計
    card.querySelector('.checkout').addEventListener('click', async ()=>{
      if(!confirm('会計を確定します。よろしいですか？')) return;
      try{
        const d = await postJSON(CHECKOUT_URL, { seat_id: seatId });
        if (d.invoice_url) window.open(d.invoice_url, '_blank');
        // ローカルも空席状態に
        itemsUL.innerHTML = '';
        stateText.textContent = '空席';
        stateChip.classList.remove('is-open');
        stateChip.classList.add('is-empty');
        btnOpen.textContent = '接客中にする';
        (card.querySelector('.guest')||{}).value = '';
        (card.querySelector('.host')||{}).value = '0';
      }catch(e){
        alert('会計に失敗しました: ' + e.message);
      }
    });
  });

  // ===== 在庫ポーリング（SSEの保険）=====
  async function refreshLiquorsOnce(){
    const r = await fetch(LIQUOR_STATUS_URL, { method:'GET' });
    const d = await r.json();
    if(d && d.ok){
      const map = {};
      for(const it of (d.items||[])){
        map[parseInt(it.id,10)] = {
          name: it.name,
          sale_price: parseInt(it.sale_price||0,10),
          stock: parseInt(it.stock||0,10)
        };
      }
      updateLiquorOptionTexts(map);
    }
  }
  (async function pollLiquors(){
    try{ await refreshLiquorsOnce(); }catch(_){}
    setTimeout(pollLiquors, 8000);
  })();

  // ===== SSE =====
  if (!window.__OPS_SSE_INITIALIZED__) {
    window.__OPS_SSE_INITIALIZED__ = true;
    const es = new EventSource(EVENTS_URL);
    es.addEventListener('ping', ()=>{});

    es.onmessage = (e)=>{
      if(!e.data) return;
      let msg={}; try{ msg = JSON.parse(e.data); }catch(_){ return; }
      const type = msg.type, data = msg.data || {};

      if(type === 'inventory_update'){
        const map = {};
        map[parseInt(data.id,10)] = {
          name: data.name,
          sale_price: parseInt(data.sale_price||0,10),
          stock: parseInt(data.stock||0,10)
        };
        updateLiquorOptionTexts(map);
      }

      if(type === 'liquor_deleted'){
        const id = String(data.id);
        document.querySelectorAll('select.liquor').forEach(sel=>{
          Array.from(sel.options).forEach(opt=>{
            if(opt.value === id) opt.remove();
          });
        });
      }

      if(type === 'order_added'){
        const card = document.querySelector(`.card[data-id="${data.seat_id}"]`);
        if(!card) return;
        const ul = card.querySelector('.items');
        const it = data.item || {};
        const qty = parseInt(it.qty||0,10);
        const up  = parseInt(it.unit_price||0,10);
        const li = document.createElement('li');
        li.textContent = `${it.name||''} x ${qty} = ¥${qty*up}`;
        ul.appendChild(li);
      }

      if(type === 'seat_update'){
        const card = document.querySelector(`.card[data-id="${data.id}"]`);
        if(!card) return;
        const stateText = card.querySelector('.state-text');
        const stateChip = card.querySelector('.state-chip');
        const btnOpen   = card.querySelector('.mark-open');
        const hostSel   = card.querySelector('.host');
        const guestInp  = card.querySelector('.guest');

        if(typeof data.open !== 'undefined'){
          const isOpen = !!data.open;
          stateText.textContent = isOpen ? '接客中' : '空席';
          stateChip.classList.toggle('is-open',  isOpen);
          stateChip.classList.toggle('is-empty', !isOpen);
          if(btnOpen) btnOpen.textContent = isOpen ? '空席にする' : '接客中にする';
        }
        if(typeof data.guest_name !== 'undefined' && guestInp){
          guestInp.value = data.guest_name || '';
        }
        if(typeof data.host_id !== 'undefined' && hostSel){
          hostSel.value = String(data.host_id || 0);
        }
        if(Array.isArray(data.items)){
          const ul = card.querySelector('.items');
          if(ul){
            ul.innerHTML = '';
            for(const it of data.items){
              const li = document.createElement('li');
              const q = parseInt(it.qty||0,10), up = parseInt(it.unit_price||0,10);
              li.textContent = `${it.name||''} x ${q} = ¥${q*up}`;
              ul.appendChild(li);
            }
          }
        }
      }

      if(type === 'checkout_done'){
        const card = document.querySelector(`.card[data-id="${data.seat_id}"]`);
        if(card){
          (card.querySelector('.items')||{}).innerHTML = '';
          const stateText = card.querySelector('.state-text');
          const stateChip = card.querySelector('.state-chip');
          const btnOpen   = card.querySelector('.mark-open');
          const guest     = card.querySelector('.guest');
          const hostSel   = card.querySelector('.host');
          if(stateText) stateText.textContent = '空席';
          if(stateChip){
            stateChip.classList.remove('is-open');
            stateChip.classList.add('is-empty');
          }
          if(btnOpen) btnOpen.textContent = '接客中にする';
          if(guest) guest.value = '';
          if(hostSel) hostSel.value = '0';
        }
        if(data.invoice_url){ window.open(data.invoice_url, '_blank'); }
      }
    };
    es.onerror = ()=>{};
  }
})();
</script>

<script>
// クリック前の確認だけ担当。キャンセル時はイベント伝播を止めて .add の処理を走らせない
function confirmAdd(ev, btn) {
  try {
    const root = btn.closest('label') || btn.parentElement;
    const sel  = root.querySelector('select.liquor');
    const qtyI = root.querySelector('input.qty');
    const opt  = sel && sel.options[sel.selectedIndex];
    const full = (opt && (opt.textContent || opt.innerText) || '商品').trim();
    const name = full.replace(/（.*?）$/, '').trim();
    const qty  = Math.max(1, parseInt(qtyI && qtyI.value || '1', 10));
    const seat = btn.dataset.seatLabel ? `席 ${btn.dataset.seatLabel} ` : '';
    const ok = window.confirm(`${seat}で『${name}』を ${qty} 追加しますか？`);
    if (!ok) {
      ev && ev.preventDefault();
      ev && ev.stopImmediatePropagation();
      ev && ev.stopPropagation();
      return false;
    }
    return true;
  } catch (e) {
    return true;
  }
}
</script>

{% endblock %}
