{% extends "store_base.html" %}
{% block store_content %}
<h2>営業状況</h2>

<div class="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;">
  {% for s in seats %}
  <div class="card" data-id="{{ s.id }}">
    <h3>{{ s.label }}</h3>

    <p>状態：
      <span class="state-chip {{ 'is-open' if s.get('open') else 'is-empty' }}">
        <span class="state-text">{{ '接客中' if s.get('open') else '空席' }}</span>
      </span>
    </p>

    <div class="field">
      <label>姫の名前
        <input class="guest" value="{{ s.guest_name or '' }}">
      </label>
    </div>

    <div class="field">
      <label>担当ホスト
        <select class="host">
          <option value="0" {% if not s.get('host_id') %}selected{% endif %}>未選択</option>
          {% for h in hosts %}
            <option value="{{ h.id }}" {% if s.get('host_id')==h.id %}selected{% endif %}>{{ h.name }}</option>
          {% endfor %}
        </select>
      </label>
    </div>

    <div class="actions">
      <button class="btn mark-open">{{ s.get('open') and '空席にする' or '接客中にする' }}</button>
      <button class="btn danger checkout">会計</button>
    </div>

    <hr>

    <div>
      <label>注文追加
        <select class="liquor">
          {% for l in liquors %}
            <option value="{{ l.id }}" data-price="{{ l.sale_price|int }}" data-stock="{{ l.stock|int }}">
              {{ l.name }}（¥{{ '%.0f'|format(l.sale_price) }} / 在庫{{ l.stock }}）
            </option>
          {% endfor %}
        </select>
        <input class="qty" type="number" value="1" min="1" style="width:64px;">
        <button class="btn add">追加</button>
      </label>

      <ul class="items">
        {% for it in s.get('items', []) %}
          <li>{{ it.name }} x {{ it.qty }} = ¥{{ '%.0f'|format(it.qty*it.unit_price) }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endfor %}
</div>

<script>
/* === 共有ヘルパ：全セレクトの表記・data属性を更新する === */
function updateLiquorOptionTexts(mapById){
  document.querySelectorAll('select.liquor').forEach(sel=>{
    Array.from(sel.options).forEach(opt=>{
      const id = parseInt(opt.value);
      const info = mapById[id];
      if(!info) return;
      const name  = (info.name ?? opt.text.split('（')[0]);
      const price = parseInt((info.sale_price ?? opt.dataset.price ?? '0'), 10);
      const stock = parseInt((info.stock ?? opt.dataset.stock ?? '0'), 10);
      opt.dataset.price = String(price);
      opt.dataset.stock = String(stock);
      opt.text = `${name}（¥${price} / 在庫${stock}）`;
    });
  });
}

(function(){
  const csrf = '{{ csrf_token() }}';

  /* === 各カードのイベント === */
  document.querySelectorAll('.card').forEach(card=>{
    const id        = parseInt(card.dataset.id);
    const guest     = card.querySelector('.guest');
    const hostSel   = card.querySelector('.host');
    const stateText = card.querySelector('.state-text');
    const stateChip = card.querySelector('.state-chip');
    const btnOpen   = card.querySelector('.mark-open');
    const itemsUL   = card.querySelector('.items');
    const liquorSel = card.querySelector('.liquor');
    const qtyInput  = card.querySelector('.qty');

    async function saveSeat(payload){
      payload.id = id;
      const res = await fetch('{{ url_for("admin.store_seats_upsert") }}', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRF-Token': csrf},
        body: JSON.stringify(payload)
      });
      return res.ok;
    }

    // 状態切替（空席⇄接客中）
    btnOpen.addEventListener('click', async ()=>{
      const open = (stateText.textContent.trim() === '空席'); // 空席→接客中
      if (await saveSeat({ open, guest_name: guest.value, host_id: parseInt(hostSel.value||0) })) {
        const isOpen = open;
        stateText.textContent = isOpen ? '接客中' : '空席';
        stateChip.classList.toggle('is-open',  isOpen);
        stateChip.classList.toggle('is-empty', !isOpen);
        btnOpen.textContent  = isOpen ? '空席にする' : '接客中にする';
      }
    });

    // 担当/姫名の変更反映
    guest.addEventListener('change', ()=> saveSeat({ guest_name: guest.value }));
    hostSel.addEventListener('change', ()=> saveSeat({ host_id: parseInt(hostSel.value||0) }));

    // 注文追加
    card.querySelector('.add').addEventListener('click', async ()=>{
      const liquorId = parseInt(liquorSel.value);
      const qty      = Math.max(1, parseInt(qtyInput.value||1));

      const res = await fetch('{{ url_for("admin.store_ops_order") }}', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRF-Token': csrf},
        body: JSON.stringify({ seat_id: id, liquor_id: liquorId, qty })
      });
      const data = await res.json().catch(()=>({}));

      if (res.ok && data.ok){
        // 明細に行を追加
        const name  = data.name || liquorSel.selectedOptions[0].text.split('（')[0];
        const price = parseInt((data.unit_price ?? liquorSel.selectedOptions[0].dataset.price ?? '0'), 10);
        const li = document.createElement('li');
        li.textContent = `${name} x ${qty} = ¥${price * qty}`;
        itemsUL.appendChild(li);

        // 在庫の即時反映（全カードのセレクトに反映）
        const map = {};
        map[data.liquor_id] = { name, sale_price: price, stock: data.stock };
        updateLiquorOptionTexts(map);

        alert('追加しました（在庫も自動減算）');
      } else if (data.error === 'no_stock') {
        alert('在庫が足りません');
      } else {
        alert('追加に失敗しました');
      }
    });

    // 会計
    card.querySelector('.checkout').addEventListener('click', async ()=>{
      if(!confirm('会計を確定します。よろしいですか？')) return;

    try{
      const res = await fetch('{{ url_for("admin.store_ops_checkout") }}', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRF-Token': csrf},
        body: JSON.stringify({ seat_id: id })
      });
      const data = await res.json().catch(()=>({}));

      if (res.ok && data.ok){
        // 請求書タブを開く
        if (data.invoice_url) window.open(data.invoice_url, '_blank');

        // 画面上の席状態をリセット
        itemsUL.innerHTML = '';
        stateText.textContent = '空席';
        stateChip.classList.remove('is-open');
        stateChip.classList.add('is-empty');
        btnOpen.textContent = '接客中にする';
        guest.value = '';
        hostSel.value = '0';
      } else {
        alert('会計に失敗しました');
      }
      }catch(e){
    alert('会計リクエスト自体に失敗しました：' + e);
      }
    });
  });

  /* === 在庫リアルタイム反映：定期ポーリング ===
     他端末での注文も含め、在庫/価格表示を最新化します。 */
  async function pollLiquors(){
    try{
      const r = await fetch('{{ url_for("admin.store_liquors_status") }}', { method:'GET' });
      const d = await r.json();
      if(d && d.ok){
        const map = {};
        for(const liq of d.liquors){
          map[parseInt(liq.id)] = {
            name: liq.name,
            sale_price: parseInt(liq.sale_price || 0, 10),
            stock: parseInt(liq.stock || 0, 10)
          };
        }
        updateLiquorOptionTexts(map);
      }
    }catch(e){
      // ネットワークエラーは無視して次回
    }finally{
      setTimeout(pollLiquors, 8000); // 8秒ごと
    }
  }
  pollLiquors();
})();
</script>
{% endblock %}
