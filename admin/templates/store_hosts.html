{% extends "store_base.html" %}
{% block store_content %}
<h2>ホスト一覧</h2>

<style>
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .toolbar .right{margin-left:auto}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #eee;padding:8px;text-align:left}
  .badge{display:inline-block;border:1px solid #ccc;border-radius:999px;padding:2px 8px;font-size:12px}
  .badge.on{border-color:#2e7d32;color:#2e7d32}
  .badge.busy{border-color:#1976d2;color:#1976d2}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center}
  .modal[hidden]{display:none}
  .modal .content{background:#fff;padding:16px;border-radius:10px;min-width:320px;max-width:90vw}
  .row{display:flex;gap:8px;align-items:center;margin:6px 0}
  .row input[type="text"]{flex:1}
  .actions{display:flex;gap:8px}
</style>

<div class="toolbar">
  <input id="new-name" placeholder="ホスト名（必須）">
  <button class="btn" id="btn-add">追加</button>
  <button class="btn danger" id="btn-del" style="display:none;">削除</button>
  <div class="right"><span class="hint">出勤中▲ → 接客中▲ → 名前昇順</span></div>
</div>

<table class="table" id="hosts-table">
  <thead>
    <tr>
      <th style="width:36px"><input type="checkbox" id="chk-all"></th>
      <th>名前</th>
      <th>ID</th>
      <th>出勤</th>
      <th>接客</th>
      <th>LINE userId</th>
      <th style="width:180px">操作</th>
    </tr>
  </thead>
  <tbody>
    {% for h in hosts %}
      {% set is_busy = (h.id in busy_ids) %}
      <tr data-id="{{ h.id }}">
        <td><input type="checkbox" class="row-chk" value="{{ h.id }}"></td>
        <td class="name">{{ h.name }}</td>
        <td>{{ h.id }}</td>
        <td>
          <label>
            <input type="checkbox" class="on-duty" {% if h.on_duty %}checked{% endif %}>
            <span class="badge on {{ 'dim' if not h.on_duty else '' }}">出勤中</span>
          </label>
        </td>
        <td>
          <span class="badge {{ 'busy' if is_busy }}">{{ '接客中' if is_busy else '—' }}</span>
        </td>
        <td class="line">{{ h.line_user_id or '' }}</td>
        <td>
          <div class="actions">
            <a class="btn" href="{{ url_for('admin.store_host_detail', host_id=h.id) }}">詳細</a>
            <button class="btn edit-name">名前変更</button>
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- 名前変更モーダル（LINE userId は表示のみ） -->
<div class="modal" id="edit-modal" hidden>
  <div class="content">
    <h3>ホスト編集</h3>
    <input type="hidden" id="edit-id">
    <div class="row"><label>名前 <input id="edit-name" type="text" required></label></div>
    <div class="row"><label>LINE userId <input id="edit-line" type="text" readonly></label></div>
    <div class="row" style="justify-content:flex-end;gap:8px;">
      <button class="btn" id="edit-cancel">キャンセル</button>
      <button class="btn primary" id="edit-save">保存</button>
    </div>
  </div>
</div>

<script>
(function(){
  const csrf='{{ csrf_token() }}';
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const tbl = $('#hosts-table tbody');
  const chkAll = $('#chk-all');
  const btnAdd = $('#btn-add');
  const btnDel = $('#btn-del');
  const inputNew = $('#new-name');

  function selectedIds(){
    return $$('.row-chk').filter(x=>x.checked).map(x=>parseInt(x.value));
  }
  function updateDelBtn(){
    btnDel.style.display = selectedIds().length ? '' : 'none';
  }

  // 追加
  btnAdd.addEventListener('click', async ()=>{
    const name = (inputNew.value||'').trim();
    if(!name){ alert('名前を入力してください'); return; }
    const res = await fetch('{{ url_for("admin.store_hosts_create") }}', {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},
      body: JSON.stringify({ name })
    });
    const data = await res.json().catch(()=>({}));
    if(res.ok && data.ok){
      location.reload();
    }else{
      alert('追加に失敗しました');
    }
  });

  // 一括削除
  btnDel.addEventListener('click', async ()=>{
    const ids = selectedIds();
    if(!ids.length) return;
    if(!confirm('選択したホストを削除します。よろしいですか？')) return;
    const res = await fetch('{{ url_for("admin.store_hosts_delete") }}', {
      method:'POST', headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},
      body: JSON.stringify({ ids })
    });
    const data = await res.json().catch(()=>({}));
    if(res.ok && data.ok){ location.reload(); } else { alert('削除に失敗しました'); }
  });

  // 全選択
  chkAll.addEventListener('change', ()=>{
    $$('.row-chk').forEach(x=> x.checked = chkAll.checked);
    updateDelBtn();
  });
  tbl.addEventListener('change', (e)=>{
    if(e.target.classList.contains('row-chk')) updateDelBtn();
  });

  // 出勤トグル
  tbl.addEventListener('change', async (e)=>{
    if(!e.target.classList.contains('on-duty')) return;
    const tr = e.target.closest('tr');
    const id = parseInt(tr.dataset.id);
    const on = !!e.target.checked;
    const badge = tr.querySelector('.badge.on');
    if(badge){ badge.style.opacity = on ? '1' : '.35'; }
    const res = await fetch('{{ url_for("admin.store_hosts_status") }}', {
      method:'POST', headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},
      body: JSON.stringify({ id, on_duty: on })
    });
    if(!res.ok){
      alert('更新に失敗しました');
      e.target.checked = !on;
      if(badge){ badge.style.opacity = (!on) ? '1' : '.35'; }
    } else {
      location.reload();
    }
  });

  // 名前変更モーダル（LINE userId は表示のみ・送信しない）
  const modal = $('#edit-modal');
  const editId = $('#edit-id');
  const editName = $('#edit-name');
  const editLine = $('#edit-line');

  tbl.addEventListener('click', (e)=>{
    if(!e.target.classList.contains('edit-name')) return;
    const tr = e.target.closest('tr');
    editId.value = tr.dataset.id;
    editName.value = tr.querySelector('.name').textContent.trim();
    editLine.value = (tr.querySelector('.line').textContent || '').trim();
    modal.hidden = false;
  });
  $('#edit-cancel').addEventListener('click', ()=> modal.hidden=true);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.hidden=true; });

  $('#edit-save').addEventListener('click', async ()=>{
    const payload = {
      id: parseInt(editId.value),
      name: editName.value.trim()
      // line_user_id は送らない（サーバ側でも無視されます）
    };
    const res = await fetch('{{ url_for("admin.store_hosts_update") }}', {
      method:'POST', headers:{'Content-Type':'application/json','X-CSRF-Token':csrf},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({}));
    if(res.ok && data.ok){
      modal.hidden = true;
      location.reload();
    }else{
      alert('保存に失敗しました');
    }
  });
})();
</script>
{% endblock %}
