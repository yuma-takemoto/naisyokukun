{% extends "base.html" %}
{% block content %}
<h1>店舗一覧</h1><p class='hint'>チェック済みのみ削除／一時停止できます。</p>

<div class="sticky-actions">
  <div class="actions-left"><label class="checkall"><input type="checkbox" id="select-all" /> 全選択</label><span id="sel-count" class="hint"></span>
    <button class="btn primary" id="btn-create">新規追加</button>
    <button class="btn" id="btn-import">CSVインポート</button>
    <input type="file" id="csv-file" accept=".csv" hidden />
    <button class="btn danger" id="btn-delete" style="display:none;">削除</button>
    <button class="btn" id="btn-suspend" style="display:none;">一時停止</button>
  </div>
  <div class="actions-right">
    <input type="search" id="store-search" placeholder="店舗を検索…" />
  </div>
</div>

<div id="edit-modal" class="modal" hidden>
  <div class="modal-content">
    <button type="button" class="modal-close" id="btn-edit-close">×</button>
    <h2>店舗を編集</h2>
    <form id="edit-form">
      <input type="hidden" name="id">
      <label>店舗名<input name="name" required></label>
      <label>住所<input name="address" required></label>
      <label>電話番号<input name="phone" required></label>
      <label>窓口者名称<input name="contact" required></label>
      <label>ログインID<input name="login_id" required></label>
      <label>パスワード<input name="password" type="password" required></label>
      <div class="modal-actions">
        <button type="button" class="btn" id="btn-edit-cancel">キャンセル</button>
        <button type="submit" class="btn primary">保存</button>
      </div>
    </form>
  </div>
</div>

<!-- 新規追加モーダル（必ず hidden を付けておく） -->
<div id="create-modal" class="modal" hidden>
  <div class="modal-content" role="dialog" aria-modal="true">
    <button type="button" class="modal-close" id="btn-close" aria-label="閉じる">×</button>
    <h2>店舗を新規追加</h2>
    <form id="create-form">
      <label>店舗名<input name="name" required></label>
      <label>住所<input name="address" required></label>
      <label>電話番号<input name="phone" required></label>
      <label>窓口者名称<input name="contact" required></label>
      <label>ログインID<input name="login_id" required></label>
      <label>パスワード<input name="password" type="password" required></label>
      <div class="modal-actions">
        <button type="button" class="btn" id="btn-cancel">キャンセル</button>
        <button type="submit" class="btn primary">登録</button>
      </div>
    </form>
  </div>
</div>


<ul class="store-list" id="store-list">
  {% for s in stores %}
  <li class="store-item {% if not s.is_active %}suspended{% endif %}" data-name="{{ s.name }} {{ s.address }} {{ s.phone }} {{ s.contact }} {{ s.login_id }} {{ s.password }}">
    <label class="store-row">
      <input type="checkbox" class="row-select" value="{{ s.id }}" />
      <span class="store-main">
        <span class="store-name">{{ s.name }}</span>
        <button class="btn edit" data-id="{{ s.id }}">編集</button>
        <a class="btn to-store" href="{{ url_for('admin.store_login') }}?login_id={{ s.login_id }}" target="_blank" rel="noopener">店舗ページへ</a>
        <span class="store-state">{% if s.is_active %}稼働中{% else %}停止中{% endif %}</span>
        <span class="store-meta">
          <span>{{ s.address }}</span>／
          <span>{{ s.phone }}</span>／
          <span>窓口：{{ s.contact }}</span>／
          <span>ホスト数：{{ host_counts.get(s.id, 0) }}</span>／
          <span>ログインID：{{ s.login_id }}</span>／
          <span>PS：{{ s.password }}</span>
        </span>
      </span>
    </label>
  </li>
  {% endfor %}
</ul>

<script>
(function(){
  const list = document.getElementById('store-list');
  const search = document.getElementById('store-search');
  const delBtn = document.getElementById('btn-delete');
  const suspendBtn = document.getElementById('btn-suspend');
  const createBtn = document.getElementById('btn-create');
  const selectAll = document.getElementById('select-all');
  const selCount = document.getElementById('sel-count');

  const checkboxes = () => Array.from(list.querySelectorAll('.row-select'));
  const selectedIds = () => checkboxes().filter(cb => cb.checked).map(cb => parseInt(cb.value));
  const anySelected = () => selectedIds().length > 0;

  const updateDeleteSuspend = () => {
    const any = anySelected();
    delBtn.style.display = any ? '' : 'none';
    suspendBtn.style.display = any ? '' : 'none';
  };
  const updateCount = () => {
    const n = selectedIds().length;
    selCount.textContent = n ? `選択: ${n}件` : '';
  };

  // ---- 検索 ----
  search.addEventListener('input', () => {
    const q = search.value.trim().toLowerCase();
    list.querySelectorAll('.store-item').forEach(li => {
      const text = li.getAttribute('data-name').toLowerCase();
      li.style.display = text.includes(q) ? '' : 'none';
    });
  });

  // ---- チェック選択 ----
  list.addEventListener('change', (e) => {
    if(e.target.classList.contains('row-select')) { updateDeleteSuspend(); updateCount(); }
  });
  if (selectAll) {
    selectAll.addEventListener('change', () => {
      checkboxes().forEach(cb => { cb.checked = selectAll.checked; });
      updateDeleteSuspend(); updateCount();
    });
  }

  // ---- モーダル制御（ここが重要）----
  const modal = document.getElementById('create-modal');      // ← hidden が付いていること！
  const form  = document.getElementById('create-form');
  const btnX  = document.getElementById('btn-close');
  const btnCancel = document.getElementById('btn-cancel');
  const modalContent = modal?.querySelector('.modal-content');

  const openModal = () => { modal.hidden = false; };
  const closeModal = () => { modal.hidden = true; form?.reset(); };

  // ボタンで開く
  createBtn.addEventListener('click', openModal);

  // × と キャンセル で閉じる
  btnX.addEventListener('click', closeModal);
  btnCancel.addEventListener('click', closeModal);

  // 背景クリック で閉じる（中身クリックはバブリング止める）
  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
  modalContent?.addEventListener('click', (e) => e.stopPropagation());

  // ESCで閉じる
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.hidden) closeModal();
  });

  // ---- 新規作成（成功時に自動クローズ & 先頭に差し込み）----
  // ---- 削除（選択行を完全削除）----
  delBtn.addEventListener('click', async () => {
    const ids = selectedIds();
    if (!ids.length) return;
    if (!confirm('選択した店舗を完全に削除します。よろしいですか？')) return;

    const res = await fetch('{{ url_for("admin.stores_delete") }}', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ ids })
    });

    if (res.ok) {
      // DOMから削除
      ids.forEach(id => {
        const row = list.querySelector(`.row-select[value="${id}"]`)?.closest('.store-item');
        if (row) row.remove();
      });
      updateDeleteSuspend(); updateCount();
    } else {
      alert('削除に失敗しました');
    }
  });

  // ---- 一時停止（OK=停止 / キャンセル=稼働に戻す）----
  suspendBtn.addEventListener('click', async () => {
    const ids = selectedIds();
    if (!ids.length) return;

    const doSuspend = confirm('一時停止しますか？（OK=停止 / キャンセル=稼働に戻す）');

    const res = await fetch('{{ url_for("admin.stores_suspend") }}', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ ids, suspend: doSuspend })
    });

    if (res.ok) {
      // 見た目を更新
      ids.forEach(id => {
        const item = list.querySelector(`.row-select[value="${id}"]`)?.closest('.store-item');
        if (item) {
          item.classList.toggle('suspended', doSuspend);
          const state = item.querySelector('.store-state');
          if (state) state.textContent = doSuspend ? '停止中' : '稼働中';
        }
      });
      updateDeleteSuspend(); updateCount();
    } else {
      alert('更新に失敗しました');
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const payload = Object.fromEntries(fd.entries());
    const res = await fetch('{{ url_for("admin.stores_create") }}', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(() => ({}));
    if (res.ok && data.ok) {
      const id = data.id;
      const li = document.createElement('li');
      li.className = 'store-item';
      li.setAttribute('data-name', `${payload.name} ${payload.address} ${payload.phone} ${payload.contact} ${payload.login_id} ${payload.password}`);
      li.innerHTML = `
        <label class="store-row">
          <input type="checkbox" class="row-select" value="${id}" />
          <span class="store-main">
            <span class="store-name">${payload.name}</span> <button class="btn edit" data-id="${id}">編集</button>
            <span class="store-meta">
              <span>${payload.address}</span>／
              <span>${payload.phone}</span>／
              <span>窓口：${payload.contact}</span>／
              <span>ホスト数：0</span>／
              <span>ログインID：${payload.login_id}</span>／
              <span>PS：${payload.password}</span>
            </span>
          </span>
        </label>`;
      list.prepend(li);
      li.querySelector('.row-select').addEventListener('change', () => { updateDeleteSuspend(); updateCount(); });
      li.querySelector('.edit').addEventListener('click', (ev) => openEdit(ev.target.dataset.id, li));
      updateDeleteSuspend(); updateCount();
      closeModal(); // ← ここで必ず閉じる
    } else {
      alert('作成に失敗しました');
    }
  });

  // ---- 既存の削除・一時停止・編集の処理（省略せずそのまま残す）----
  // ※ 既にあるコードが動いているならそのままでOK

  // 初期状態
  updateDeleteSuspend(); updateCount();
})();
</script>

{% endblock %}
